<mat-toolbar color="primary">
  <span>Mis Tareas</span>
  <span class="spacer"></span>
  <span class="user-email">{{ authService.currentUserEmail() }}</span>
  <button mat-icon-button (click)="onLogout()" aria-label="Cerrar sesión">
    <mat-icon>logout</mat-icon>
  </button>
</mat-toolbar>

<div class="container">
  <!-- Formulario para nueva tarea -->
  <mat-card class="add-task-card">
    <mat-card-content>
      <form [formGroup]="newTaskForm" (ngSubmit)="onCreateTask()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="title-field">
            <mat-label>Nueva tarea</mat-label>
            <input
              matInput
              formControlName="title"
              placeholder="¿Qué necesitas hacer?"
              [disabled]="!!(creating$ | async)"
            />
            @if (newTaskForm.get('title')?.hasError('required') &&
            newTaskForm.get('title')?.touched) {
            <mat-error>El título es requerido</mat-error>
            } @if (newTaskForm.get('title')?.hasError('minlength')) {
            <mat-error>Mínimo 3 caracteres</mat-error>
            } @if (newTaskForm.get('title')?.hasError('maxlength')) {
            <mat-error>Máximo 80 caracteres</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="desc-field">
            <mat-label>Descripción (opcional)</mat-label>
            <input
              matInput
              formControlName="description"
              placeholder="Detalles..."
              [disabled]="!!(creating$ | async)"
            />
            @if (newTaskForm.get('description')?.hasError('maxlength')) {
            <mat-error>Máximo 200 caracteres</mat-error>
            }
          </mat-form-field>

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="newTaskForm.invalid || !!(creating$ | async)"
            class="add-button"
          >
            @if (creating$ | async) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            <mat-icon>add</mat-icon>
            Agregar }
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading inicial -->
  @if (loading$ | async) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando tareas...</p>
  </div>
  } @else if ((tasks$ | async)?.length === 0) {
  <!-- Estado vacío -->
  <div class="empty-state">
    <mat-icon class="empty-icon">check_circle_outline</mat-icon>
    <h2>No hay tareas</h2>
    <p>¡Agrega tu primera tarea usando el formulario de arriba!</p>
  </div>
  } @else {
  <!-- Lista de tareas -->
  <div class="tasks-list">
    @for (task of tasks$ | async; track trackByTaskId($index, task)) {
    <app-task-item
      [task]="task"
      (toggle)="onToggleComplete($event)"
      (edit)="onEditTask($event)"
      (delete)="onDeleteTask($event)"
    ></app-task-item>
    }
  </div>
  }
</div>
